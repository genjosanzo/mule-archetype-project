#set( $symbol_pound = '#' )
#set( $symbol_dollar = '$' )
#set( $symbol_escape = '\' )
<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:spring="http://www.springframework.org/schema/beans" xmlns:test="http://www.mulesoft.org/schema/mule/test"
	xmlns:file="http://www.mulesoft.org/schema/mule/file" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:jdbc="http://www.mulesoft.org/schema/mule/jdbc" xmlns:jms="http://www.mulesoft.org/schema/mule/jms"
	xmlns:vm="http://www.mulesoft.org/schema/mule/vm" xmlns:client="http://www.mulesoft.org/schema/mule/client"
	xmlns:cxf="http://www.mulesoft.org/schema/mule/cxf" xmlns:management="http://www.mulesoft.org/schema/mule/management"
	xmlns:scripting="http://www.mulesoft.org/schema/mule/scripting"
	xmlns:sxc="http://www.mulesoft.org/schema/mule/sxc" xmlns:mule-xml="http://www.mulesoft.org/schema/mule/xml"
	xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/3.2/mule.xsd
        http://www.mulesoft.org/schema/mule/test http://www.mulesoft.org/schema/mule/test/3.2/mule-test.xsd
        http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/3.2/mule-file.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/3.2/mule-http.xsd
        http://www.mulesoft.org/schema/mule/jdbc http://www.mulesoft.org/schema/mule/jdbc/3.2/mule-jdbc.xsd
        http://www.mulesoft.org/schema/mule/jms http://www.mulesoft.org/schema/mule/jms/3.2/mule-jms.xsd
        http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/3.2/mule-vm.xsd
        http://www.mulesoft.org/schema/mule/client http://www.mulesoft.org/schema/mule/client/3.2/mule-client.xsd
        http://www.mulesoft.org/schema/mule/cxf http://www.mulesoft.org/schema/mule/cxf/3.2/mule-cxf.xsd
        http://www.mulesoft.org/schema/mule/management http://www.mulesoft.org/schema/mule/management/3.2/mule-management.xsd
        http://www.mulesoft.org/schema/mule/scripting http://www.mulesoft.org/schema/mule/scripting/3.2/mule-scripting.xsd
        http://www.mulesoft.org/schema/mule/sxc http://www.mulesoft.org/schema/mule/sxc/3.2/mule-sxc.xsd
        http://www.mulesoft.org/schema/mule/xml http://www.mulesoft.org/schema/mule/xml/3.2/mule-xml.xsd
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">


	<description>
		Synergy Integration Bus configuration.
	</description>

	<configuration defaultResponseTimeout="1000000000">
		<default-dispatcher-threading-profile
			maxThreadsActive="50" maxThreadsIdle="25" threadTTL="60000" />
		<default-receiver-threading-profile
			maxThreadsActive="50" maxThreadsIdle="25" threadTTL="60000" />
		<default-service-threading-profile
			maxThreadsActive="50" maxThreadsIdle="25" threadTTL="60000" />
	</configuration>
	<spring:bean
		class="${packageInPathFormat}.tangoe.synergy.sib.transformers.SynergyClientRequestTransformer"
		name="synergClientRequestTransformer" init-method="init"/>
	<spring:bean
		class="${packageInPathFormat}.tangoe.synergy.sib.transformers.UnwrapRequestTransformer"
		name="unwrapRequestTransformer" />
		
	<mule-xml:jaxb-context name="myJaxb" packageNames="${packageInPathFormat}.tangoe.services.synergyservice.types"/>
	
	<flow name="sibSynergyClientFlow">
		<http:inbound-endpoint address="http://localhost:8989/services/synergy-bus"
			exchange-pattern="request-response">
			<cxf:proxy-service wsdlLocation="SynergyService.wsdl"
				namespace="http://www.tangoe.${packageInPathFormat}/services/SynergyService" service="SynergyService"
				payload="body" />
		</http:inbound-endpoint>
		<custom-transformer name="xsrtoxml" class="org.mule.module.xml.transformer.XmlToOutputHandler" />
		<${packageInPathFormat}ponent class="${packageInPathFormat}.tangoe.synergy.sib.transformers.MyLogComponent"></${packageInPathFormat}ponent>
		<mule-xml:xml-to-dom-transformer returnClass="org.w3c.dom.Document" />		
		
		<transformer ref="synergClientRequestTransformer"/>
		
		<logger level="ERROR" message="1) ${symbol_pound}[payload]"></logger>
		<transformer ref="unwrapRequestTransformer"/>
		<logger level="ERROR" message="2) ${symbol_pound}[payload]"></logger>
		<mule-xml:jaxb-object-to-xml-transformer jaxbContext-ref="myJaxb" returnClass="java.lang.String"/>
		<logger level="ERROR" message="3) ${symbol_pound}[payload]"></logger>
		<outbound-endpoint address="http://localhost:8990"
			exchange-pattern="request-response" responseTimeout="60000">
			<cxf:proxy-client payload="body" />
		</outbound-endpoint>
	</flow>
	<flow name="mockService">
		<http:inbound-endpoint address="http://localhost:8990" />
		<${packageInPathFormat}ponent class="${packageInPathFormat}.tangoe.synergy.sib.transformers.MyLogComponent"></${packageInPathFormat}ponent>
		<scripting:transformer>
			<scripting:script engine="groovy" name="transformer">
				<scripting:text><![CDATA[
					xml = '''
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
  <soap:Body>
    <InvokeResponse xmlns="http://www.tangoe.${packageInPathFormat}/services/SynergyService/Types">
      <serviceResponse>
        <synergyMessageHeader>
          <destination>
            <securityContext>
              <clients/>
            </securityContext>
          </destination>
          <properties/>
        </synergyMessageHeader>
        <synergyMessagePayload>
          <AuthenticationResponse:AuthenticationResponse xmlns:AuthenticationResponse="http://synergy.tangoe.${packageInPathFormat}/tangoe/messages/security/authentication" xmlns="http://synergy.tangoe.${packageInPathFormat}/tangoe/messages/security/authentication">
            <authenticated>true</authenticated>
            <accountExpired>false</accountExpired>
            <accountLocked>false</accountLocked>
            <credentialsExpired>false</credentialsExpired>
            <disabled>false</disabled>
            <failureReason>success</failureReason>
          </AuthenticationResponse:AuthenticationResponse>
        </synergyMessagePayload>
      </serviceResponse>
    </InvokeResponse>
  </soap:Body>
</soap:Envelope>
 						
 					'''
				return xml
 					]]>
				</scripting:text>
			</scripting:script>
		</scripting:transformer>
		<logger level="ERROR" category="service-invoked" message="${symbol_pound}${symbol_pound}${symbol_pound}${symbol_pound}${symbol_pound}${symbol_pound}${symbol_pound}${symbol_pound}${symbol_pound}${symbol_pound}${symbol_pound}${symbol_pound}"></logger>
	</flow>


</mule>